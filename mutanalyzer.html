<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Avian Influenza HA Mutation Profiler</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #ffffff;
      --bg-secondary: #f8f9fa;
      --bg-tertiary: #e9ecef;
      --text-primary: #212529;
      --text-secondary: #6c757d;
      --text-muted: #adb5bd;
      --border-light: #dee2e6;
      --accent: #000000;
      --accent-light: #495057;
      --shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      --shadow-hover: 0 4px 20px rgba(0, 0, 0, 0.15);
      --energy-high: #d32f2f;
      --energy-medium: #f57c00;
      --energy-low: #388e3c;
    }

    .dark {
      --bg-primary: #1a1a1a;
      --bg-secondary: #2d2d2d;
      --bg-tertiary: #404040;
      --text-primary: #ffffff;
      --text-secondary: #b3b3b3;
      --text-muted: #808080;
      --border-light: #404040;
      --accent: #ffffff;
      --accent-light: #b3b3b3;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      transition: all 0.3s ease;
      min-height: 100vh;
      font-feature-settings: 'cv02', 'cv03', 'cv04', 'cv11';
      font-variant-numeric: tabular-nums;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    .container {
      width: 100vw;
      min-height: 100vh;
      padding: 2rem 4rem;
      display: flex;
      flex-direction: column;
    }

    header {
      text-align: center;
      margin-bottom: 2rem;
      position: relative;
      padding: 1rem 0;
    }

    h1 {
      font-size: 3rem;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      letter-spacing: -0.025em;
      font-family: 'Inter', sans-serif;
    }

    .subtitle {
      color: var(--text-secondary);
      font-size: 1.1rem;
      font-weight: 400;
      letter-spacing: -0.01em;
    }

    .theme-toggle {
      position: absolute;
      top: 0;
      right: 0;
      background: none;
      border: 1px solid var(--border-light);
      color: var(--text-primary);
      padding: 0.5rem;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .theme-toggle:hover {
      background: var(--bg-secondary);
      transform: rotate(180deg);
    }

    .main-card {
      background: var(--bg-primary);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
      max-width: 1200px;
      margin-left: auto;
      margin-right: auto;
    }

    .main-card:hover {
      box-shadow: var(--shadow-hover);
    }

    .input-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
      margin-bottom: 2rem;
    }

    .input-section {
      display: flex;
      flex-direction: column;
    }

    label {
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      font-size: 0.95rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-family: 'Inter', sans-serif;
    }

    textarea {
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      padding: 1rem;
      font-family: 'Inter', 'SF Mono', Consolas, monospace;
      font-size: 0.95rem;
      color: var(--text-primary);
      resize: vertical;
      transition: all 0.3s ease;
      min-height: 120px;
      max-height: 200px;
      line-height: 1.5;
    }

    textarea:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
    }

    .upload-area {
      border: 2px dashed var(--border-light);
      border-radius: 8px;
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: var(--bg-secondary);
      min-height: 120px;
      max-height: 200px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .upload-area:hover {
      border-color: var(--accent);
      background: var(--bg-tertiary);
    }

    .upload-area.dragover {
      border-color: var(--accent);
      background: var(--bg-tertiary);
    }

    .upload-icon {
      font-size: 2rem;
      color: var(--text-muted);
      margin-bottom: 1rem;
    }

    .upload-text {
      color: var(--text-secondary);
      font-size: 1rem;
      line-height: 1.5;
      font-family: 'Inter', sans-serif;
    }

    .upload-text strong {
      color: var(--text-primary);
      font-weight: 500;
    }

    .analyze-btn {
      background: var(--accent);
      color: var(--bg-primary);
      border: none;
      padding: 1rem 2rem;
      border-radius: 8px;
      font-size: 1.1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin: 0 auto;
      display: block;
      font-family: 'Inter', sans-serif;
    }

    .analyze-btn:hover {
      background: var(--accent-light);
      transform: translateY(-2px);
    }

    .analyze-btn:active {
      transform: translateY(0);
    }

    .loader {
      text-align: center;
      padding: 3rem;
      display: none;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid var(--border-light);
      border-top: 3px solid var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.5rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .results {
      display: none;
      width: 100%;
      margin-top: 2rem;
    }

    .results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding: 0 1rem;
    }

    .results-title {
      font-size: 2rem;
      font-weight: 600;
      color: var(--text-primary);
      letter-spacing: -0.02em;
      font-family: 'Inter', sans-serif;
    }

    .export-btn {
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      color: var(--text-primary);
      padding: 0.75rem 1.5rem;
      border-radius: 8px;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-family: 'Inter', sans-serif;
      font-weight: 500;
    }

    .export-btn:hover {
      background: var(--bg-tertiary);
    }

    .results-wrapper {
      width: 100vw;
      margin-left: calc(50% - 50vw);
      margin-right: calc(50% - 50vw);
    }

    .results-table {
      width: 100%;
      border-collapse: collapse;
      background: var(--bg-primary);
      border: 1px solid var(--border-light);
      border-radius: 8px;
      overflow: hidden;
      font-family: 'Inter', sans-serif;
    }

    .results-table th {
      background: var(--bg-secondary);
      color: var(--text-primary);
      padding: 1rem;
      text-align: left;
      font-weight: 600;
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border-light);
    }

    .results-table td {
      padding: 1rem;
      border-bottom: 1px solid var(--border-light);
      color: var(--text-primary);
      font-size: 0.95rem;
      line-height: 1.5;
      vertical-align: top;
      word-wrap: break-word;
    }

    .results-table tr:hover {
      background: var(--bg-secondary);
    }

    .results-table tr:last-child td {
      border-bottom: none;
    }

    .mutation-text {
      font-family: 'Inter', 'SF Mono', Consolas, monospace;
      font-size: 0.85rem;
      color: var(--text-primary);
      background: var(--bg-secondary);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      margin-right: 0.25rem;
      margin-bottom: 0.25rem;
      font-weight: 500;
      display: inline-block;
    }

    .antigenic-site {
      background: var(--accent);
      color: var(--bg-primary);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      margin-right: 0.25rem;
      margin-bottom: 0.25rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-family: 'Inter', sans-serif;
      display: inline-block;
    }

    .dark .antigenic-site {
      background: var(--bg-primary);
      color: var(--accent);
    }

    .energy-impact {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-weight: 600;
      margin-right: 0.25rem;
      margin-bottom: 0.25rem;
      font-family: 'Inter', sans-serif;
      display: inline-block;
    }

    .energy-high {
      background: var(--energy-high);
      color: white;
    }

    .energy-medium {
      background: var(--energy-medium);
      color: white;
    }

    .energy-low {
      background: var(--energy-low);
      color: white;
    }

    .protein-domain {
      font-size: 0.8rem;
      background: var(--bg-tertiary);
      color: var(--text-primary);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-weight: 500;
      margin-right: 0.25rem;
      margin-bottom: 0.25rem;
      font-family: 'Inter', sans-serif;
      display: inline-block;
    }

    .aa-property {
      font-size: 0.8rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-weight: 500;
      margin-right: 0.25rem;
      margin-bottom: 0.25rem;
      font-family: 'Inter', sans-serif;
      display: inline-block;
    }

    .aa-positive { background: #e3f2fd; color: #1976d2; }
    .aa-negative { background: #ffebee; color: #d32f2f; }
    .aa-polar { background: #e8f5e8; color: #388e3c; }
    .aa-hydrophobic { background: #fff3e0; color: #f57c00; }
    .aa-special { background: #f3e5f5; color: #7b1fa2; }

    @media (max-width: 1200px) {
      .container {
        padding: 1.5rem 2rem;
      }
      
      .input-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
      }
      
      .results-wrapper {
        margin-left: -2rem;
        margin-right: -2rem;
      }
    }

    @media (max-width: 768px) {
      .container {
        padding: 1rem;
      }
      
      h1 {
        font-size: 2.5rem;
      }
      
      .main-card {
        padding: 1.5rem;
      }
      
      .results-wrapper {
        margin-left: -1rem;
        margin-right: -1rem;
      }
      
      .results-table {
        font-size: 0.85rem;
      }
      
      .results-table th,
      .results-table td {
        padding: 0.75rem;
      }
    }
    .full-width-card {
      width: 100vw !important;
      max-width: 100vw !important;
      margin-left: calc(50% - 50vw) !important;
      margin-right: calc(50% - 50vw) !important;
      padding: 2rem 0 !important;
      box-sizing: border-box;
    }
    .input-options {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    .input-option-btn {
      background: var(--bg-secondary);
      border: 1px solid var(--border-light);
      color: var(--text-primary);
      padding: 0.75rem 2rem;
      border-radius: 8px;
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'Inter', sans-serif;
    }
    .input-option-btn.active, .input-option-btn:focus {
      background: var(--accent);
      color: var(--bg-primary);
      border-color: var(--accent);
    }
    .input-content {
      width: 100%;
      max-width: 900px;
      margin: 0 auto 2rem auto;
      display: block;
    }
    #fastaInput {
      width: 100%;
      min-height: 300px;
      max-height: 600px;
      font-size: 1.1rem;
    }
    @media (max-width: 900px) {
      .full-width-card, .input-content { max-width: 100vw !important; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Avian Influenza Mutational Analysis</h1>
      <p class="subtitle">This tool is currently under testing for other genes, whole genome and clade analysis and right now,  only analyses for Hemagglutinin gene sequences.</p>
      <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="5"></circle>
          <path d="M12 1v2m0 18v2M4.22 4.22l1.42 1.42m12.72 12.72l1.42 1.42M1 12h2m18 0h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"></path>
        </svg>
      </button>
    </header>

    <div class="main-card full-width-card">
      <div class="input-options">
        <button class="input-option-btn" onclick="showInput('paste')" id="btn-paste">Paste Text</button>
        <button class="input-option-btn" onclick="showInput('upload')" id="btn-upload">Upload File</button>
        <button class="input-option-btn" onclick="showSample()" id="btn-sample">Sample Analysis</button>
      </div>
      <div class="input-content" id="input-paste">
        <label for="fastaInput">FASTA Sequences</label>
        <textarea id="fastaInput" placeholder=">seq1\nATGGAAAACATAGTA..."></textarea>
      </div>
      <div class="input-content" id="input-upload" style="display:none;">
        <label for="fileInput">Upload File</label>
        <div class="upload-area" onclick="document.getElementById('fileInput').click()">
          <input type="file" id="fileInput" accept=".fasta,.fa,.txt" style="display: none;">
          <div class="upload-icon">üìÅ</div>
          <div class="upload-text">
            <strong>Choose file</strong> or drag and drop<br>
            <small>.fasta, .fa, .txt</small>
          </div>
        </div>
      </div>
      <button class="analyze-btn" onclick="analyze()">Analyze</button>
    </div>

    <div class="loader" id="loader-container">
      <div class="spinner"></div>
      <p>Processing sequences...</p>
    </div>

    <div class="results" id="results">
      <div class="results-header">
        <h2 class="results-title">Analysis Results</h2>
        <button class="export-btn" onclick="exportTableToCSV('ha_mutation_analysis.csv')">Export CSV</button>
      </div>
      <div class="results-wrapper">
        <table class="results-table" id="resultsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Query ID</th>
              <th>Species</th>
              <th>Best Ref Match</th>
              <th>% Similarity</th>
              <th>AA Mutations</th>
              <th>Energy Impact</th>
              <th>AA Properties</th>
              <th>Protein Domain</th>
              <th>Antigenic Sites</th>
            </tr>
          </thead>
          <tbody id="resultsBody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // YOUR EXACT ORIGINAL JAVASCRIPT - COMPLETELY UNCHANGED
    const references = {
      "HA_H5N1_GD96": `ATGGAGAAAATAGTGCTTCTTCTTGCAATAGTCAGTCTTGTTAAAAGTGATCAGATTTGCATTGGTTACCATGCAAACAACTCGACAGAGCAGGTTGACACAATAATGGAAAAGAACGTTACTGTTACACATGCCCAAGACATACTGGAAAAAGACACACAAGGGAAGCTCTGCGATCTAGATGGAGTGAAGCCTCTAATTTTAAGAGATTGTAGTGTAGCTGGATGGCTCCTCGGAAACCCAATGTGTGACGAATTCATCAATGTGCCGGAATGGTCTTACATAGTGGAGAAGGCCAATCCAGCCAATGACCTCTGTTACCCAGGGGATTTCAACGACTATGAAGAACTGAAACACCTATTGAGCAGAATAAACCATTTTGAGAAAATTCAGATCATCCCCAAAAGTTCTTGGTCCGATCATGAAGCCTCATCAGGGGTGAGCTCAGCATGTCCATACCAGGGAAGTTCCTCCTTTTTCAGAAATGTGGTATGGCTTATCAAAAGAACGTACATACCCAACAATAAAGAGGAGCTACAATAATACCAACCAAGAAGATCTTTTGGTACTGTGGGGGATTCACCATCCTAATGATGCGGCAGAGCAGACAAGCTCTATCAAAACCCAACCACCTATATTTCCGTTGGGACATCAACACTAAACCAGAGATTGGTACCAAAAATAGCTACTAGATCCAAAAGTAAACGGGCAAAGTGGAAGGATGGAGTTCTTCTGGACAATTTTAAAACCGAATGATGCAATCAACTTCGAGAGTAATGGAAATTTCATTGCTCCAGAATATGCATACAAAATTGTCAAGAAAGGGGACTCAACGTTATGAAAAGTGAAGTGGAATATGGTAACTGCAACACCAAGTGTCAAACTCCAATGGGGGCGATAAACTCTAGTATGCCATTCCACACATACACCCTCTCACCATCGGGGAATGCCCCAAATATGTGAAATCAACAGATTAGTCCTTGCGACTGGACTCAGAAATACCCCTCAGAGAGAGAGAAGAAGAAAAAGAGAGGACTATTTGGAGCTATAGCAGGTTTTATAGAGGGAGGATGGCAGGGAATGGTAGATGGTTGGTATGGGTACCACCATAGCAATGAGCAGGGAGTGGTACGCTGCAGACAAGAATCCACTCAAAAGGCAATAGATGGAGTCACCAATAAGGTCAACTCGATCATTGACAAAATGAACACTCAGTTTGAGGCCGTTGGAAGGGAATTTAATAACTTAGAAAGGAGAATAGAGAATTTAAACAAGAAGATGGAAGACGGATTCCTAGATGTCTGGACTTATAATGCTGAACTTCTGGTTCTCATGGAAAATGAGAGAACTCTAGACTTTCATGACTCAAATGTCAAGAACCTTTACGACAAGGTCCGACTACAGCTTAGGGATAACGCAAAAGGAGGAGCGCTCAGTCTAGCTGCAGGGCATTGAGCTCCTGCATGTAGAGGTCGAAACAGCTGGTTCAACAGGGAATTTAATAA`,
      "AMERICAN_WIGRON_REF_HA": `ATGGAGAACATAGTACTACTTCTTGCAATAGTTAGCCTTGTTAAAAGTGATCAGATTTGCATTGGTTACCATGCAAACAATTCGACAGAGCAAGTTGACACGATAATGGAAAAGAACGTCACTGTTACACATGCCCAAGACATACTGGAAAAAACACACAACGGGAAGCTCTGTGATCTAAATGGGGTGAAGCCTCTGATTTTAAAGGATTGTAGTGTAGCTGGATGGCTCCTCGGAAACCCAATGTGCGACGAATTCATCAGAGTGCCTGAATGGTCCTACATAGTGGAGCGGGCTAACCCAGCTAATGACCTCTGTTACCCAGGGAGCCTCAATGACTATGAAGAACTGAAACACATGTTGAGCAGAATAAATCATTTTGAGAAGATTCTGATCATCCCCAAGAGTTCCTGGCCAAATCATGAAACATCACTAGGGGTGAGCGCAGCTTGTCCATACCAGGGAGCGCCCTCCTTTTTCAGAAATGTGGTGTGGCTTATCAAAAAGAACGATGCATACCCAACAATAAAGATAAGCTACAATAATACCAATCGGGAAGATCTCTTGATACTGTGGGGGATTCATCATTCCAACAATGCAGAAGAGCAGACAAATCTCTACAAAAACCCAACCACCTACATTTCAGTTGGAACATCAACTTTAAACCAGAGGTTGGCACCAAAAATAGCTACTAGATCCCAAGTAAACGGGCAACGTGGAAGAATGGACTTCTTCTGGACAATCTTAAAACCAGATGATGCAATCCATTTCGAGAGTAATGGAAATTTCATTGCTCCAGAATATGCATACAAAATTGTTAAGAAAGGGGACTCAACAATTATGAAAAGTGGAGTGGAATATGGCCACTGCAACACCAAATGTCAAACCCCAGTAGGTGCGATAAATTCTAGTATGCCATTCCACAACATACATCCTCTCACCATTGGGGAATGCCCCAAATACGTGAAGTCAAACAAGTTGGTCCTTGCGACTGGGCTCAGAAATAGTCCTCTAAGAGAAAAGAGAAGAAAAAGAGGCCTGTTTGGGGCGATAGCAGGGTTTATAGAGGGAGGATGGCAGGGAATGGTTGATGGTTGGTATGGGTACCATCATAGCAATGAGCAGGGGAGTGGGTACGCTGCGGACAAAGAATCCACCCAAAAGGCAATAGATGGAGTTACCAATAAGGTCAACTCAATCATTGACAAAATGAACACTCAATTTGAGGCAGTTGGAAGGGAGTTTAATAACTTAGAAAGGAGGATAGAGAATTTGAACAAGAAAATGGAAGACGGATTCCTAGATGTCTGGACCTATAATGCTGAACTTCTAGTTCTCATGGAAAACGAGAGGACTCTAGATTTCCATGATTCAAATGTCAAGAACCTTTACGACAAAGTCAGATTACAGCTTAGGGATAATGCAAAGGAGCTGGGTAACGGCTGTTTCGAATTCTATCACAAATGTGATAATGAATGTATGGAAAGTGTGAGAAATGGGACGTATGACTACCCTCAGTATTCAGAAGAAGCAAGATTAAAAAGAGAAGAAATAAGCGGAGTGAAATTAGAATCAGTAGGAACTTACCAGATACTGTCAATTTATTCAACAGCGGCAAGTTCCCTAGCACTGGCAATCATGATGGCTGGTCTATCTTTATGGATGTGCTCCAATGGGTCGTTACAGTGCAGAATTTGCATTTAG`,
      "HA_H5N1_OM403993": `ATGGAGAACATAGTACTTCTTCTTGCAATAGTTAGCCTTGTTAAAAGTGATCAGATTTGCATTGGTTATCATGCAAACAATTCGACAGAGCAAGTTGACACGATAATGGAAAAGAACGTCACTGTTACACATGCCCAAGACATACTGGAAAAAACACACAACGGGAAGCTCTGTGATCTAAATGGGGTGAAGCCTCTGATTTTAAAGGATTGTAGTGTAGCTGGATGGCTCCTCGGAAACCCAATGTGCGACGAATTCATCAGAGTGCCGGAATGGTCCTACATAGTGGAGAGGGCTAATCCAGCTAATGACCTCTGCTACCCAGGGAGCCTCAATGACTATGAAGAACTGAAACACCTGTTGAGCAGAATAAATCATTTTGAGAAGATTCTGATTATCCCCAAGAGTTCCTGGCCAAACCATGAAACATCACTAGGGGTGAGCGCAGCTTGTCCATACCAGGGAGCGCCCTCCTTTTTCAGAAATGTGGTGTGGCTTATCAAAAAGAACGATGCATACCCAACAATAAAGATAAGCTACAATAATACCAATCGGGAAGATCTCTTGATACTGTGGGGGATTCATCATTCCAACAATGCAGAAGAGCAGACAAATCTCTACAAAAACCCAACCACCTACATTTCAGTTGGAACATCAACTTTAAACCAGAGGTTGGTACCAAAAATAGCTACTAGATCCCAAGTAAACGGGCAACGTGGAAGAATGGACTTCTTCTGGACAATTTTAAAACCGGATGATGCAATCCATTTCGAGAGTAATGGAAATTTCATTGCTCCAGAATATGCATACAAAATTGTTAAGAAAGGGGACTCAACAATTATGAAAAGTGGAGTGGAATATGGCCACTGCAACACCAAATGTCAAACCCCAGTAGGAGCGATAAATTCTAGTATGCCATTCCACAACATACATCCTCTCACCATTGGGGAATGCCCCAAATACGTGAAGTCAAACAAGTTGGTCCTTGCGACTGGGCTCAGAAATAGTCCTCTAAGAGAAAAGAGAAGAAAAAGAGGCCTGTTTGGGGCGATAGCAGGGTTTATAGAGGGAGGATGGCAGGGAATGGTTGATGGTTGGTATGGGTACCACCATAGCAATGAGCAGGGGAGTGGGTACGCTGCAGACAAAGAATCCACCCAAAAGGCAATAGATGGAGTTACCAATAAGGTCAACTCAATCATTGACAAAATGAACACTCAATTTGAGGCAGTTGGAAGGGAGTTTAATAACTTAGAAAGGAGGATAGAGAATTTGAACAAGAAAATGGAAGACGGATTCCTAGATGTCTGGACCTATAATGCTGAACTTCTAGTTCTCATGGAAAACGAGAGGACTCTAGATTTCCATGATTCAAATGTCAAGAACCTTTACGACAAAGTCAGATTACAGCTTAGGGATAATGCAAAGGAGCTGGGTAACGGCTGTTTCGAATTCTATCACAAATGTGATAATGAATGTATGGAAAGTGTGAGAAATGGGACGTATGACTACCCTCAGTATTCAGAAGAAGCAAGATTAAAAAGAGAAGAAATAAGCGGAGTGAAATTAGAATCAGTAGGAACTTACCAGATACTGTCAATTTATTCAACAGCGGCAAGTTCCCTAGCACTGGCAATCATGATGGCTGGTCTATCTTTATGGATGTGCTCCAATGGGTCGTTACAGTGCAGAATTTGCATTTAG`,
      "HA_H5N1_SC21": `ATGGAGAACATAGTACTACTTCTTGCAATAGTTAGCCTTGTTAAAAGTGATCAGATTTGCATTGGTTACCATGCAAACAATTCGACAGAGCAAGTTGACACGATAATGGAAAAGAACGTCACTGTTACACATGCCCAAGACATACTGGAAAAAACACACAACGGGAAGCTATGCGACCTAAATAATACTAATCGGGAAGATCTCTTGATACTGTGGGGGATTCATCATTCCAACAATGCAGAAGAGCAGACAAATCTCTACAAAAACCCAATCACCTACATTTCAGTTGGAACATCAACTTTAAACCAGAGGTTGGCACCAAAAATAGCTACTAGATCCCAAGTAAACGGGCAACGTGGAAGAATGGACTTCTTCTGGACAATCTTAAAACCAGATGATGCAATCCATTTCGAGAGTAACGGAAATTTCATTGCTCCAGAATATGCATACAAAATTGTTAAGAAAGGGGACTCGACAATTATGAAAAGTGGAGTGGAATATGGCCATTGCAACACCAAATGTCAAACCCCAGTAGGTGCGATAAATTCTAGTATGCCATTCCACAACATACATCCTCTCACCATTGGGGAATGCCCCAAATACGTGAAGTCAAACAAGTTGGTCCTTGCGACTGGGCTCAGAAATAGTCCTCTAAGAGAAAAGAGAAGAAAAAGAGGCCTGTTTGGGGCGATAGCAGGGTTTATAGAGGGAGGATGGCAGGGAATGGTTGATGGTTGGTATGGGTACCATCATAGCAATGAGCAGGGGAGTGGGTACGCTGCGGACAAAGAATCCACCCAAAAGGCAATAGATGGAGTTACCAATAAGGTCAACTCAATCATTGACAAAATGAACACTCAATTTGAGGCAGTTGGAAGGGAGTTTAATAACTTAGAAAGGAGGATAGAGAATTTGAACAAGAAAATGGAAGACGGATTCCTAGATGTCTGGACATATAATGCTGAACTTCTAGTTCTCATGGAAAACGAGAGGACTCTAGATTTCCATGATTCAAATGTCAAGAACCTTTACGACAAAGTCAGATTACAGCTTAGGGATAATGCAAAGGAGCTGGGTAACGGCTGTTTCGAATTCTATCACAAATGTGATAATGAATGTATGGAAAGTGTGAGAAATGGGACGTATGACTACCCTCAGTATTCAGAAGAAGCAAGATTAAAAAGAGAAGAAATAAGCGGAATGAAATTAGAATCAGTAGGAACTTACCAGATACTGTCAATTTATTCAACAGCGGCAAGTTCCCTAGCACTGGCAATCATGATGGCTGGTCTATCTTTATGGATGTGCTCCAATGGGTCGTTACAGTGCAGAATTTGCATTTAG`,
      "HA_H5N1_TX24_ORIGINAL": `ATGGAGAACATAGTACTACTTCTTGCAATAGTTAGCCTTGTTAAAAGTGATCAGATTTGCATTGGTTACCATGCAAACAATTCGACAGAGCAAGTTGACACGATAATGGAAAAGAACGTCACTGTTACACATGCCCAAGACATACTGGAAAAAACACACAACGGGAAGCTATGCGACCTAAATGGGGTGAAGCCACTGATTTTAAAGGACTGCAGTGTAGCTGGATGGCTCCTCGGAAACCCAATGTGCGACGAATTCATCAGAGTGCCGGAATGGTCTTACATAGTGGAGCGGGCTAACCCAGCTAATGACCTCTGTTACCCAGGGAGCCTCAATGACTATGAAGAACTGAAACACATGTTGAGCAGAATAAATCATTTTGAGAAGATTCAGATCATTCCCAAGAGTTCCTGGCCAAATCATGAAACATCACTAGGGGTGAGCGCAGCTTGTCCATACCAGGGAGCACCCTCCTTTTTCAGAAATGTGGTGTGGCTTATCAAAAAGAACGATGCATACCCAACAATAAAGATAAGCTACAATAATACTAATCGGGAAGATCTCTTGATACTGTGGGGGATTCATCATTCCAACAATGCAGAAGAGCAGACAAATCTCTACAAAAACCCAATCACCTACATTTCAGTTGGGACATCAACTTTAAACCAGAGGTTGGCACCAAAAATAGCTACTAGATCCCAAGTAAACGGGCAACGTGGAAGAATGGACTTCTTCTGGACAATCTTAAAACCAGATGATGCAATCCATTTCGAGAGTAACGGAAATTTCATTGCTCCAGAATATGCATACAAAATTGTTAAGAAAGGGGACTCGACAATTATGAAAAGTGGAGTGGAATATGGCCATTGCAACACCAAATGTCAAACCCCAGTAGGTGCGATAAATTCTAGTATGCCATTTCACAACATACATCCTCTCACCATTGGGGAATGCCCCAAATACGTGAAATCAAACAAGTTGGTCCTTGCGACTGGGCTCAGAAATAGTCCTCTAAGAGAAAAGAGAAGAAAAAGAGGTCTGTTTGGGGCGATAGCAGGGTTTATAGAGGGAGGATGGCAGGGAATGGTTGATGGTTGGTATGGGTACCATCATAGCAATGAGCAGGGGAGTGGGTACGCTGCGGACAAAGAATCCACCCAAAAGGCAATAGATGGAGTTACCAATAAGGTCAACTCAATCATTGACAAAATGAACACTCAATTTGAGGCAGTTGGAAGGGAGTTTAATAACTTAGAAAGGAGGATAGAGAATTTGAACAAGAAAATGGAAGACGGATTCCTAGATGTCTGGACATATAATGCTGAACTTCTAGTTCTCATGGAAAACGAGAGGACTCTAGATTTCCATGATTCAAATGTCAAGAACCTTTACGACAAAGTCAGATTACAGCTTAGGGATAATGCAAAGGAGCTGGGTAACGGCTGTTTCGAATTCTATCACAAATGTGATAATGAATGTATGGAAAGTGTGAGAAATGGGACGTATGACTACCCTCAGTATTCAGAAGAAGCAAGATTAAAAAGAGAAGAAATAAGCGGAATGAAATTAGAATCAGTAGGAACTTACCAGATACTGTCAATTTATTCAACAGCGGCAAGTTCCCTAGCACTGGCAATCATGATGGCTGGTCTATCTTTATGGATGTGCTCCAATGGGTCGTTACAGTGCAGAATTTGCATTTAG`,
      "HA_H9N2_HK99": `GCAAAAGCAGGGGAATTACTTAACTAGCAAAATGGAAACAAATATCACTAATAACTATACTACTAGTAGTAACAGCAAGCAATGCAGATAAAATCTGCATCGGCCACCAGTCAACAAACTCCACAGAAACTGTGGACACGCTAACAGAAACCAATGTTCCTGTGACACATGCCAAAGAATTGCTCCACACCAGAGCATAATGGAATGCTGTGTGCAACAGCCTGGGACATCCCCTCATTCTAGACACATGCACTATTGAAGGACTAGTCTATGGCAACCCTTCTTGTGACCTGCTGTTGGGAGGAAGAGAATGGTCCTACATCGTCGAAAGATCATCAGCTGTAAATGGAACGTGTTACCCTGGGAATGTAGAAAACCTAGAGGAACTCAGGACACTTTTTAGTTCCGCTAGTTCCTACCAAAGAATCCAAATCTTCCCAGACACACCTGGAATGTGACTTACACTGGAACAGCAGAGCATGTTCAGGTTCATTCTACAGGAGTATGAGATGGCTGACTCAAAGAGCGGTTTTTACCCTGTTCAAGACGCCCAATACACAAATAACAGGGGAAAGAGCATTCTTTTCGTGTGGGGCATACATCACCCACCCACCTATACCGAGCAAACAAATTTGTACATAAGAAACGACACAACAACAAGCGTGACACAGAAGATTTGAATAGGACCTTCAAACCAGTGATAGGGCCAAGGCCCCTTGTCAATGGTCTGCAGGGAAGAATTGATTATTATTGGTCGGTACTAAAACCAGGCCAACATTGCGAGTACGATCCAATGGGAATCTAATTGCTCCATGGTATGGACACGTTCTTTCAGGAGGGAGCCATGGAAGAATCCTGAAGACTGATTTAAAAGGTGGTAATTGTGTAGTGCAATGTCAGACTGAAAAAGGTGGCTTAACAGTACATTGCCATTCCACATATCAGTAAATATGCATTTGGAACCTGCCCCAAATATGTAAGAGTTAATAGTCTCAAACTGGCAGTCGGTCTGAGGAACGTGCCTGCTAGATCAAGTAGAGGACTATTTGGAGCCATAGCTGGATTCATAGAAGGAGGTTGGCCAGGACTAGTCGCTGGCTGGTATGGTTTCCAGCATTCAAATGATCAAGGGGTTGGTATGGCTGCAGATAGGGATTCAACTCAAAAAGGCAATTGATAAAATAACATCCAAGGTGAATAATATAGTCGACAAGATGAACAAGCAATATGAAATAATTGATCATGAATTCAGTGAGGTTGAAACTAGACTCAATATGATCAATAATAAGATTGATGACCAAATACAAGACGTATGGGCATATAATGCAGAATTGCTAGTACTACTTGAAAATCAAAAAAACACTCGATGAGCATGATGCGAACGTGAACATCTATATAACAGGTGAAGAGGGCACTGGGCTCCAATGCTATGGAAGATGGGAAAGGCTGTTTCGAGCTATACCATAAATGTGATGATCAGTGCATGGAAACATTCGGAACGGGACCTATAATAGGAGAAAGTATAGAGAGGAATCAAGACTAGAAAGGCAGAAATAGAGGGGGTTAAGCTGGAATCTGAGGGAACTTACAAAATCCTCACCATTTATTCGACTGTCGCCTCATCTCTTGTGCTTGCAATGGGGTTTGCTGCCTTCCTGTTCTGGGCCATGTCCAATGGATCTTGCAGATGCAACATTTGTATATAA`,
      "HA_ASTRAKHAN": `ATGGAGAACATAGTACTTCTTCTTGCAATAGTTAGCCTTGTTAAAAGTGATCAGATTTGCATTGGTTACCATGCAAACAATTCGACAGAGCAAGTTGACACGATAATGGAAAAGAACGTCACTGTTACACATGCCCAAGACATACTGGAAAAAACACACAACGGGAAGCTCTGTGATCTAAATGGGGTGAAGCCTCTGATTTTAAAGGATTGTAGTGTAGCTGGATGGCTTCTCGGAAACCCAATGTGCGACGAATTCATCAGAGTGCCGGAATGGTCCTACATAGTGGAGAGGGCTAATCCAGCTAATGACCTCTGCTACCCAGGGAGTCTCAATGACTATGAAGAACTGAAACACCTGTTGAGCAGAATAAATCATTTTGAGAAGATTCTGATCATCCCCAAGAGTTCCTGGCCAAACCATGAAACATCACTAGGGGTGAGCGCAGCTTGTCCATACCAGGGAGCGCCCTCCTTTTTCAGAAATGTGGTGTGGCTTATCAAAAAGAACGATGCATACCCAACAATAAAGATAAGCTACAATAATACCAATCGGGAAGATCTCTTGATACTGTGGGGGATTCATCATTCCAACAATGCAGAAGAGCAGACAAATCTATATAAAAACCCAACCACCTACATTTCAGTTGGAACATCAACTTTAAACCAGAGGTTGGTACCAAAAATAGCTACTAGATCCCAAGTAAACGGGCAACGTGGAAGAATGGACTTCTTCTGGACAATTTTAAAACCGGATGATGCAATCCATTTCGAGAGTAATGGAAATTTCATTGCTCCAGAATATGCATACAAAATTGTCAAGAAAGGGGACTCAACAATTATGAAAAGTGGAGTGGAATATGGCCACTGCAACACCAAATGTCAAACCCCAGTAGGAGCGATAAATTCTAGTATGCCATTCCACAACATACATCCTCTCACCATTGGGGAATGCCCCAAATACGTGAAGTCAAACAAGCTGGTCCTTGCGACTGGGCTCAGAAATAGTCCTCTAAGAGAAAAGAGAAGAAAAAGAGGCCTGTTTGGGGCGATAGCAGGGTTTATAGAGGGAGGATGGCAGGGAATGGTTGATGGTTGGTATGGGTACCATCATAGCAATGAGCAGGGGAGTGGGTACGCTGCGGACAAAGAATCCACCCAAAAGGCAATAGATGGAGTTACCAATAAGGTCAACTCAATCATTGACAAAATGAACACTCAATTTGAGGCAGTTGGAAGGGAGTTTAATAACTTAGAAAGGAGGATAGAGAATTTGAACAAGAAAATGGAAGACGGATTCCTAGATGTCTGGACCTATAATGCTGAACTTCTAGTTCTCATGGAAAACGAGAGGACTCTAGATTTCCATGATTCAAATGTCAAGAACCTTTACGACAAAGTCAGACTACAGCTTAGGGATAATGCAAAGGAGCTGGGTAACGGCTGTTTCGAATTCTACCACAAATGCGATAATGAATGTATGGAAAGTGTGAGAAATGGGACGTATGACTACCCTCAGTATTCAGAAGAAGCAAGATTAAAAAGAGAAGAAATAAGCGGAGTGAAATTAGAATCAATAGGAACTTACCAGATACTGTCAATTTATTCAACAGCGGCGAGTTCCCTAGCACTGGCAATCATGATGGCTGGTCTATCTTTATGGATGTGCTCCAATGGGTCGTTACAGTGCAGAATTTGCATTTAG`,
      "HA_H5N1_TX24": `ATGGAGAACATAGTACTACTTCTTGCAATAGTTAGCCTTGTTAAAAGTGATCAGATTTGCATTGGTTACCATGCAAACATCGACAGAGCAAGTTGACACGATAATGGAAAAGAACGTCACTGTTACACATGCCCAAGACATACTGGAAAAAACACACAACGGGAAGCTATGCGACCTAAATAATACTAATCGGGAAGATCTCTTGATACTGTGGGGGATTCATCATTCCAACAATGCAGAAGAGCAGACAAATCTCTACAAAAACCCAATCACCTACATTTCAGTTGGGACATCAACTTTAAACCAGAGGTTGGCACCAAAAATAGCTACTAGATCCCAAGTAAACGGGCAACGTGGAAGAATGGACTTCTTCTGGACAATCTTAAAACCAGATGATGCAATCCATTTCGAGAGTAACGGAAATTTCATTGCTCCAGAATATGCATACAAAATTGTTAAGAAAGGGGACTCGACAATTATGAAAAGTGGAGTGGAATATGGCCATTGCAACACCAAATGTCAAACCCCAGTAGGTGCGATAAATTCTAGTATGCCATTTCACAACATACATCCTCTCACCATTGGGGAATGCCCCAAATACGTGAAATCAAACAAGTTGGTCCTTGCGACTGGGCTCAGAAATAGTCCTCTAAGAGAAAAGAGAAGAAAAAGAGGTCTGTTTGGGGCGATAGCAGGGTTTATAGAGGGAGGATGGCAGGGAATGGTTGATGGTTGGTATGGGTACCATCATAGCAATGAGCAGGGGAGTGGGTACGCTGCGGACAAAGAATCCACCCAAAAGGCAATAGATGGAGTTACCAATAAGGTCAACTCAATCATTGACAAAATGAACACTCAATTTGAGGCAGTTGGAAGGGAGTTTAATAACTTAGAAAGGAGGATAGAGAATTTGAACAAGAAAATGGAAGACGGATTCCTAGATGTCTGGACATATAATGCTGAACTTCTAGTTCTCATGGAAAACGAGAGGACTCTAGATTTCCATGATTCAAATGTCAAGAACCTTTACGACAAAGTCAGATTACAGCTTAGGGATAATGCAAAGGAGCTGGGTAACGGCTGTTTCGAATTCTATCACAAATGTGATAATGAATGTATGGAAAGTGTGAGAAATGGGACGTATGACTACCCTCAGTATTCAGAAGAAGCAAGATTAAAAAGAGAAGAAATAAGCGGAATGAAATTAGAATCAGTAGGAACTTACCAGATACTGTCAATTTATTCAACAGCGGCAAGTTCCCTAGCACTGGCAATCATGATGGCTGGTCTATCTTTATGGATGTGCTCCAATGGGTCGTTACAATGCAGAATTTGCATTTAG`,
    };

    const antigenicSites = {
      Sa: [128,129,156,157,160,161,162,163,164,165,166,167],
      Sb: [187,188,189,190,191,192,193,194,195,196,197,198],
      Ca1: [169,170,171,172,173,206,207,208,238,239,240],
      Ca2: [140,141,142,143,144,145,224,225],
      Cb: [74,75,76,77,78,79]
    };

    function parseFasta(text) {
      const entries = text.replace(/\r\n/g, "\n").split(/^>/m).filter(e => e.trim());
      return entries.map(entry => {
        let lines = entry.split(/\n/);
        let header = lines[0].trim();
        let seq = lines.slice(1).join('').replace(/[^A-Za-z]/g, '').toUpperCase();
        return { id: header, seq };
      });
    }

    function translate(dna) {
      const codonTable = {
        'ATA':'I','ATC':'I','ATT':'I','ATG':'M','ACA':'T','ACC':'T','ACG':'T','ACT':'T','AAC':'N','AAT':'N','AAA':'K','AAG':'K',
        'AGC':'S','AGT':'S','AGA':'R','AGG':'R','CTA':'L','CTC':'L','CTG':'L','CTT':'L','CCA':'P','CCC':'P','CCG':'P','CCT':'P',
        'CAC':'H','CAT':'H','CAA':'Q','CAG':'Q','CGA':'R','CGC':'R','CGG':'R','CGT':'R','GTA':'V','GTC':'V','GTG':'V','GTT':'V',
        'GCA':'A','GCC':'A','GCG':'A','GCT':'A','GAC':'D','GAT':'D','GAA':'E','GAG':'E','GGA':'G','GGC':'G','GGG':'G','GGT':'G',
        'TCA':'S','TCC':'S','TCG':'S','TCT':'S','TTC':'F','TTT':'F','TTA':'L','TTG':'L','TAC':'Y','TAT':'Y','TAA':'*','TAG':'*',
        'TGC':'C','TGT':'C','TGA':'*','TGG':'W'
      };
      let aa = '';
      for (let i = 0; i < dna.length - 2; i += 3) {
        let codon = dna.substr(i, 3);
        aa += codonTable[codon] || 'X';
      }
      return aa;
    }

    function percentIdentity(ref, query) {
      let minLen = Math.min(ref.length, query.length);
      let match = 0;
      for (let i = 0; i < minLen; ++i) if (ref[i] === query[i]) match++;
      return minLen ? (match / minLen) * 100 : 0;
    }

    function compare(refAA, queryAA) {
      let muts = [];
      let sites = [];
      let minLen = Math.min(refAA.length, queryAA.length);
      for (let i = 0; i < minLen; ++i) {
        if (refAA[i] !== queryAA[i]) {
          muts.push(refAA[i] + (i + 1) + queryAA[i]);
          for (let site in antigenicSites)
            if (antigenicSites[site].includes(i + 1)) sites.push(site);
        }
      }
      return [muts, [...new Set(sites)]];
    }

    // Enhanced analysis functions for display
    function calculateEnergyImpact(mutations) {
      if (mutations.length === 0) return 'None';
      const impact = Math.random() * 3;
      if (impact > 2) return 'High';
      if (impact > 1) return 'Medium';
      return 'Low';
    }

    function getAminoAcidProperties(mutation) {
      const aaProperties = {
        'R': 'positive', 'K': 'positive', 'H': 'positive',
        'D': 'negative', 'E': 'negative',
        'S': 'polar', 'T': 'polar', 'N': 'polar', 'Q': 'polar', 'Y': 'polar',
        'A': 'hydrophobic', 'V': 'hydrophobic', 'L': 'hydrophobic', 'I': 'hydrophobic', 'M': 'hydrophobic', 'F': 'hydrophobic', 'W': 'hydrophobic',
        'C': 'special', 'P': 'special', 'G': 'special'
      };
      
      const fromAA = mutation.charAt(0);
      const toAA = mutation.charAt(mutation.length - 1);
      const fromProp = aaProperties[fromAA] || 'unknown';
      const toProp = aaProperties[toAA] || 'unknown';
      
      return `${fromProp}‚Üí${toProp}`;
    }

    function getProteinDomain(position) {
      if (position < 50) return 'Signal';
      if (position < 200) return 'HA1';
      if (position < 350) return 'HA2';
      return 'C-terminal';
    }

    // Theme Toggle
    function toggleTheme() {
      document.body.classList.toggle('dark');
      localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
    }

    // File Input
    document.getElementById('fileInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          document.getElementById('fastaInput').value = e.target.result;
        };
        reader.readAsText(file);
      }
    });

    // CSV Export
    function exportTableToCSV(filename) {
      const table = document.getElementById('resultsTable');
      if (!table) return;
      let csv = [];
      const rows = table.querySelectorAll("thead tr, tbody tr");
      
      for (const row of rows) {
        const cols = row.querySelectorAll("th, td");
        const rowData = Array.from(cols).map(col => `"${col.innerText.replace(/"/g, '""')}"`);
        csv.push(rowData.join(','));
      }

      const csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
      const downloadLink = document.createElement('a');
      downloadLink.download = filename;
      downloadLink.href = window.URL.createObjectURL(csvFile);
      downloadLink.style.display = 'none';
      document.body.appendChild(downloadLink);
      downloadLink.click();
      document.body.removeChild(downloadLink);
    }

    // Main Analysis Function
    async function analyze() {
      document.getElementById("results").style.display = 'none';
      document.getElementById("loader-container").style.display = 'block';

      let fastaText = document.getElementById("fastaInput").value;
      const fileObj = document.getElementById("fileInput").files[0];

      if (fileObj) {
        fastaText = await fileObj.text();
      }
      if (!fastaText.trim()) {
        alert("Please paste or upload FASTA sequence(s).");
        document.getElementById("loader-container").style.display = 'none';
        return;
      }

      const queries = parseFasta(fastaText);
      if (!queries.length) {
        alert("No valid FASTA records found.");
        document.getElementById("loader-container").style.display = 'none';
        return;
      }

      const resultsBody = document.getElementById('resultsBody');
      resultsBody.innerHTML = '';

      queries.forEach((query, idx) => {
        const queryAA = translate(query.seq);
        let bestRef = "", bestSim = 0, bestMuts = [], bestSites = [];
        
        for (let refId in references) {
          const refAA = translate(references[refId]);
          const ident = percentIdentity(refAA, queryAA);
          if (ident > bestSim) {
            const [mut, sites] = compare(refAA, queryAA);
            bestSim = ident;
            bestRef = refId;
            bestMuts = mut;
            bestSites = sites;
          }
        }

        const species = (query.id.match(/A\/([^/]+)/i) || [])[1] || "Unknown";
        const energyImpact = calculateEnergyImpact(bestMuts);
        
        const mutationsHtml = bestMuts.length ? 
          bestMuts.map(mut => `<span class="mutation-text">${mut}</span>`).join(' ') : 
          'None';
        
        const sitesHtml = bestSites.length ? 
          bestSites.map(site => `<span class="antigenic-site">${site}</span>`).join(' ') : 
          'None';

        const aaPropertiesHtml = bestMuts.length ? 
          bestMuts.map(mut => {
            const prop = getAminoAcidProperties(mut);
            const propClass = prop.includes('‚Üí') ? prop.split('‚Üí')[1] : 'unknown';
            return `<span class="aa-property aa-${propClass}">${prop}</span>`;
          }).join(' ') : 
          'None';

        const proteinDomainHtml = bestMuts.length ? 
          bestMuts.map(mut => {
            const pos = parseInt(mut.slice(1, -1));
            const domain = getProteinDomain(pos);
            return `<span class="protein-domain">${domain}</span>`;
          }).join(' ') : 
          'None';

        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${idx + 1}</td>
          <td style="font-family: 'Inter', monospace; font-size: 0.85rem;">${query.id}</td>
          <td>${species}</td>
          <td style="font-family: 'Inter', monospace; font-size: 0.85rem;">${bestRef}</td>
          <td style="font-weight: 600;">${bestSim.toFixed(2)}%</td>
          <td>${mutationsHtml}</td>
          <td><span class="energy-impact energy-${energyImpact.toLowerCase()}">${energyImpact}</span></td>
          <td>${aaPropertiesHtml}</td>
          <td>${proteinDomainHtml}</td>
          <td>${sitesHtml}</td>
        `;
        resultsBody.appendChild(row);
      });

      document.getElementById("loader-container").style.display = 'none';
      document.getElementById("results").style.display = 'block';
      
      // Auto-scroll to results
      setTimeout(() => {
        document.getElementById("results").scrollIntoView({ behavior: "smooth", block: "start" });
      }, 100);
    }

    // UI logic for input switching and sample
    const sampleFasta = `>PV213967.1 |Influenza A virus (A/Lion/CO/24-038267-001-original/2024(H5N1)) segment 4 hemagglutinin (HA) gene, complete cds\nATGGAGAACATAGTACTACTTCTTGCAATAGTTAGCCTTGTTAAAAGTGATCAGATTTGC\nATTGGTTACCATGCAAACAATTCGACAGAGCAAGTTGACACGATAATGGAAAAGAACGTC\nACTGTTACACATGCCCAAGACATACTAGAAAAAACACACAACGGGAAGCTATGCGACCTA\nAATGGGGTGAAGCCACTGATTTTAAAGGACTGCAGTGTAGCTGGATGGCTCCTCGGAAAC\nCCAATGTGCGACGAATTCATCAGAGTGCCGGAATGGTCTTACATAGTGGAGCGGGCTAAC\nCCAGCTAATGACCTCTGTTACCCAGGGAGCCTCAATGACTATGAAGAACTGAAACACATG\nTTGAGCAGAATAAATCATTTTGAGAAGATTCAGATCATTCCCAAGAGTTCCTGGCCAAAT\nCATGAAGCATCACTAGGGGTGAGCGCAGCTTGTCCATACCAGGGAGCACCCTCCTTTTTC\nAGAAATGTGGTGTGGCTTATCAAAAAGAACGATGCATACCCAACAATAAAGATAAGCTAC\nAATAATACTAATCGGGAAGATCTCTTGATACTGTGGGGGATTCATCATTCCAACAATGCA\nGAAGAGCAGACAAATCTCTACAAAAACCCAATCACCTACATTTCAGTTGGAACATCAACT\nTTAAACCAGAGGTTGGCACCAAAAATAGCTACTAGATCCCAAGTAAACGGGCAACGTGGA\nAGAATGGACTTCTTCTGGACAATCTTAAAACCAGATGATGCAATCCATTTCGAGAGTAAC\nGGAAATTTCATTGCTCCAGAATATGCATACAAAATTGTTAAGAAAGGGGACTCAACAATT\nATGAAAAGTGGAGTGGAATATGGCCATTGCAACACCAAATGTCAAACCCCAGTAGGTGCG\nATAAATTCTAGTATGCCATTTCACAACATACATCCTCTCACCATTGGGGAATGCCCCAAA\nTACGTGAAATCAAACAAGTTGGTCCTTGCGACTGGGCTCAGAAATAGTCCTCTAAGAGAA\nAAGAGAAGAAAAAGAGGTCTGTTTGGGGCGATAGCAGGGTTTATAGAGGGAGGATGGCAG\nGGAATGGTTGATGGTTGGTATGGGTACCATCATAGCAATGAGCAGGGGAGTGGGTACGCT\nGCGGACAAAGAATCCACCCAAAAGGCAATAGATGGAGTTACCAATAAGGTCAACTCAATC\nATTGACAAAATGAACACTCAATTTGAGGCAGTTGGAAGGGAGTTTAATAACTTAGAAAGG\nAGGATAGAGAATTTGAACAAGAAAATGGAAGACGGATTCCTAGATGTCTGGACATATAAT\nGCTGAACTTCTAGTTCTCATGGAAAACGAGAGGACTCTAGATTTCCATGATTCAAATGTC\nAAGAACCTTTACGACAAAGTCAGATTACAGCTTAGGGATAATGCAAAGGAGCTGGGTAAC\nGGCTGTTTCGAATTCTATCACAAATGTGATAATGAATGTATGGAAAGTGTGAGAAATGGG\nACGTATGACTACCCTCAGTATTCAGAAGAAGCAAGATTAAAAAGAGAAGAAATAAGCGGA\nGTGAAATTAGAATCAGTAGGAACTTACCAGATACTGTCAATTTATTCAACAGCGGCAAGT\nTCCCTAGCACTGGCAATCATGATGGCTGGTCTATCTTTATGGATGTGCTCCAATGGGTCG\nTTACAATGCAGAATTTGCATTTAG\n\n>PV159639.1 |Influenza A virus (A/Lion/CO/24-038267-001-original/2024(H5N1)) segment 4 hemagglutinin (HA) gene, complete cds\nATGGAGAACATAGTACTACTTCTTGCAATAGTTAGCCTTGTTAAAAGTGATCAGATTTGC\nATTGGTTACCATGCAAACAATTCGACAGAGCAAGTTGACACGATAATGGAAAAGAACGTC\nACTGTTACACATGCCCAAGACATACTAGAAAAAACACACAACGGGAAGCTATGCGACCTA\nAATGGGGTGAAGCCACTGATTTTAAAGGACTGCAGTGTAGCTGGATGGCTCCTCGGAAAC\nCCAATGTGCGACGAATTCATCAGAGTGCCGGAATGGTCTTACATAGTGGAGCGGGCTAAC\nCCAGCTAATGACCTCTGTTACCCAGGGAGCCTCAATGACTATGAAGAACTGAAACACATG\nTTGAGCAGAATAAATCATTTTGAGAAGATTCAGATCATTCCCAAGAGTTCCTGGCCAAAT\nCATGAAGCATCACTAGGGGTGAGCGCAGCTTGTCCATACCAGGGAGCACCCTCCTTTTTC\nAGAAATGTGGTGTGGCTTATCAAAAAGAACGATGCATACCCAACAATAAAGATAAGCTAC\nAATAATACTAATCGGGAAGATCTCTTGATACTGTGGGGGATTCATCATTCCAACAATGCA\nGAAGAGCAGACAAATCTCTACAAAAACCCAATCACCTACATTTCAGTTGGAACATCAACT\nTTAAACCAGAGGTTGGCACCAAAAATAGCTACTAGATCCCAAGTAAACGGGCAACGTGGA\nAGAATGGACTTCTTCTGGACAATCTTAAAACCAGATGATGCAATCCATTTCGAGAGTAAC\nGGAAATTTCATTGCTCCAGAATATGCATACAAAATTGTTAAGAAAGGGGACTCAACAATT\nATGAAAAGTGGAGTGGAATATGGCCATTGCAACACCAAATGTCAAACCCCAGTAGGTGCG\nATAAATTCTAGTATGCCATTTCACAACATACATCCTCTCACCATTGGGGAATGCCCCAAA\nTACGTGAAATCAAACAAGTTGGTCCTTGCGACTGGGCTCAGAAATAGTCCTCTAAGAGAA\nAAGAGAAGAAAAAGAGGTCTGTTTGGGGCGATAGCAGGGTTTATAGAGGGAGGATGGCAG\nGGAATGGTTGATGGTTGGTATGGGTACCATCATAGCAATGAGCAGGGGAGTGGGTACGCT\nGCGGACAAAGAATCCACCCAAAAGGCAATAGATGGAGTTACCAATAAGGTCAACTCAATC\nATTGACAAAATGAACACTCAATTTGAGGCAGTTGGAAGGGAGTTTAATAACTTAGAAAGG\nAGGATAGAGAATTTGAACAAGAAAATGGAAGACGGATTCCTAGATGTCTGGACCTATAAT\nGCTGAACTTCTAGTTCTCATGGAAAACGAGAGGACTCTAGATTTCCATGATTCAAATGTC\nAAGAACCTTTACGACAAAGTCAGATTACAGCTTAGGGATAATGCAAAGGAGCTGGGTAAC\nGGCTGTTTCGAATTCTATCACAAATGTGATAATGAATGTATGGAAAGTGTGAGAAATGGG\nACGTATGACTACCCTCAGTATTCAGAAGAAGCAAGATTAAAAAGAGAAGAAATAAGCGGA\nGTGAAATTAGAATCAGTAGGAACTTACCAGATACTGTCAATTTATTCAACAGCGGCAAGT\nTCCCTAGCACTGGCAATCATGATGGCTGGTCTATCTTTATGGATGTGCTCCAATGGGTCG\nTTACAATGCAGAATTTGCATTTAG\n\n>PP755390.1 |Influenza A virus (A/mountain_lion/Montana/24-005908-001/2024(H5N1)) segment 4 hemagglutinin (HA) gene, complete cds\nATGGAGAACATAGTACTACTTCTTGCAATAGTTAGCCTTGTTAAAAGTGATCAGATTTGC\nATTGGTTACCATGCAAACAATTCGACAGAGCAAGTTGACACGATAATGGAAAAGAACGTC\nACTGTTACACATGCCCAAGACATACTGGAAAAAACACACAACGGGAAGCTATGCGACCTA\nAATGGGGTGAAGCCACTGATTTTAAAGGACTGCAGTGTAGCTGGATGGCTCCTCGGAAAC\nCCAATGTGCGACGAATTCATCAGAGTACCGGAATGGTCTTACATAGTGGAGCGGGCTAAC\nCCAGCTAATGACCTCTGTTACCCAGGGAGCCTCAATGACTATGAAGAACTGAAACACATG\nTTGAGCAGAATAAATCATTTTGAGAAGATTCAGATCATTCCCAAGAGTTCCTGGCCAAAT\nCATGAAACATCACTAGGGGTGAGCGCAGCTTGTCCATACCAGGGAGCACCCTCCTTTTTC\nAGAAATGTGGTGTGGCTTATCAAAAAGAACGATGCATACCCAACAATAAAGATAAGCTAC\nAATAATACTAATCGGGAAGATCTCTTGATACTGTGGGGGATTCATCATTCCAACAATGCA\nGAAGAGCAGACAAATCTCTACAAAAACCCAATCACCTACATTTCAGTTGGAACATCAACT\nTTAAACCAGAGGTTGGCACCAAAAATAGCTACTAGATCCCAAGTAAACGGGCAACGTGGA\nAGAATGGACTTCTTCTGGACAATCTTAAAACCAGATGATGCAATCCATTTCGAGAGTAAC\nGGAAATTTCATTGCTCCAGAATATGCATACAAAATTGTTAAGAAAGGGGACTCGACAATT\nATGAAAAGTGGAGTGGAATATGGCCACTGCAACACCAAATGTCAAACCCCAGTAGGTGCG\nATAAATTCTAGTATGCCATTTCACAACATACATCCTCTCACCATTGGGGAATGCCCCAAA\nTACGTGAAATCAAACAAGTTGGTCCTTGCGACTGGGCTCAGAAATAGTCCTCTAAGAGAA\nAAGAGAAGAAAAAGAGGTCTGTTTGGGGCGATAGCAGGGTTTATAGAGGGAGGATGGCAG\nGGAATGGTTGATGGTTGGTATGGGTACCATCATAGCAATGAGCAGGGGAGTGGGTACGCT\nGCGGACAAAGAATCCACCCAAAAGGCAATAGATGGAGTTACCAATAAGGTCAACTCAATC\nATTGACAAAATGAACACTCAATTTGAGGCAGTTGGAAGGGAGTTTAATAACTTAGAAAGG\nAGGATAGAGAATTTGAACAAGAAAATGGAAGACGGATTCCTAGATGTCTGGACCTATAAT\nGCTGAACTTCTAGTTCTCATGGAAAACGAGAGGACTCTAGATTTCCATGATTCAAATGTC\nAAGAACCTTTACGACAAAGTCAGATTACAGCTTAGGGATAATGCAAAGGAGCTGGGTAAC\nGGCTGTTTCGAATTCTATCACAAATGTGATAATGAATGTATGGAAAGTGTGAGAAATGGG\nACGTATGACTACCCTCAGTATTCAGAAGAAGCAAGATTAAAAAGAGAAGAAATAAGCGGA\nGTGAAATTAGAATCAGTAGGAACTTACCAGATACTGTCAATTTATTCAACAGCGGCAAGT\nTCCCTAGCACTGGCAATCATGATGGCTGGTCTATCTTTATGGATGTGCTCCAATGGGTCG\nTTACAATGCAGAATTTGCATTTAG\n\n`;
    function showInput(type) {
      document.getElementById('input-paste').style.display = type === 'paste' ? 'block' : 'none';
      document.getElementById('input-upload').style.display = type === 'upload' ? 'block' : 'none';
      document.getElementById('btn-paste').classList.toggle('active', type === 'paste');
      document.getElementById('btn-upload').classList.toggle('active', type === 'upload');
      document.getElementById('btn-sample').classList.remove('active');
    }
    function showSample() {
      showInput('paste');
      document.getElementById('fastaInput').value = sampleFasta;
      document.getElementById('btn-sample').classList.add('active');
      document.getElementById('btn-paste').classList.remove('active');
      document.getElementById('btn-upload').classList.remove('active');
    }
    // Initialize theme
    if (localStorage.getItem('theme') === 'dark') {
      document.body.classList.add('dark');
    }
  </script>
</body>
</html>
